 API Gateway (Backend for Frontend)


 Цели проекта

* Реализация API Gateway (BFF)
* Агрегация данных из нескольких микросервисов
* Реализация кэширования с использованием Redis
* Настройка мониторинга на базе Prometheus и Grafana
* Обеспечение отказоустойчивости 
* Предоставление единого REST API для клиентских приложений

---

 Архитектура

Архитектура разделена на несколько логических уровней, каждый из которых выполняет строго определённую роль.

 Клиентский уровень

Клиентскими потребителями системы являются веб- или мобильные приложения. Клиенты взаимодействуют исключительно с API Gateway, не имея прямого доступа к внутренним микросервисам. Взаимодействие осуществляется по протоколу HTTP с использованием REST API.

Такой подход позволяет изолировать клиентские приложения от изменений во внутренней структуре системы и предоставляет единый, стабильный интерфейс доступа к данным.

API Gateway (Backend for Frontend)

API Gateway является центральным компонентом системы и выполняет функции промежуточного слоя между клиентами и микросервисами. Он реализован на FastAPI и работает как отдельный сервис.

Основные обязанности API Gateway:

* приём входящих запросов от клиентов;
* агрегация данных из нескольких микросервисов;
* кэширование агрегированных ответов в Redis;
* реализация fallback-механизмов при отказе отдельных сервисов;
* экспорт метрик для системы мониторинга;
* выполнение health checks зависимых компонентов.

API Gateway параллельно обращается к микросервисам, что снижает общее время обработки запроса и повышает производительность системы.

 Микросервисы

Система включает три независимых микросервиса, каждый из которых отвечает за свою предметную область:

* User Service — управление и предоставление данных пользователей;
* Order Service — работа с заказами пользователей;
* Product Service — предоставление информации о товарах.

Каждый микросервис:

* реализован как отдельное FastAPI-приложение;
* имеет собственные REST endpoints;
* предоставляет endpoint для проверки состояния (health check);
* не хранит состояние клиентов и не зависит от других микросервисов напрямую.

Взаимодействие между микросервисами осуществляется только через API Gateway, что соответствует принципам слабой связанности.

 Кэширование

Для повышения производительности и снижения нагрузки на микросервисы используется кэширование агрегированных данных в Redis. Кэш имеет ограниченное время жизни (TTL — 30 секунд).

В случае недоступности Redis API Gateway использует in-memory кэш, что позволяет системе продолжать работу в деградированном режиме без полного отказа обслуживания.

 Мониторинг и наблюдаемость

Для наблюдения за состоянием системы используется стек Prometheus и Grafana. API Gateway и вспомогательные компоненты экспортируют метрики, которые собираются Prometheus и визуализируются в Grafana.

Мониторинг охватывает:

* производительность API Gateway;
* состояние кэша;
* количество и типы ошибок;
* системные ресурсы контейнеров.

 Контейнеризация

Все компоненты системы разворачиваются в Docker-контейнерах и управляются с помощью Docker Compose. Это обеспечивает воспроизводимость окружения, упрощает развертывание и изоляцию сервисов.

---

 Технологический стек

 Backend

* Python 3.11
* FastAPI
* Uvicorn
* HTTPX
* Redis
* Prometheus Client

 Контейнеризация и оркестрация

* Docker
* Docker Compose

 Мониторинг и наблюдаемость

* Prometheus
* Grafana
* Redis Exporter
* Node Exporter

---

 Быстрый старт

```
chmod +x start_with_monitoring.sh
./start_with_monitoring.sh
```

После запуска доступны:

* API Gateway: [http://localhost:8000](http://localhost:8000)
* Prometheus: [http://localhost:9090](http://localhost:9090)
* Grafana: [http://localhost:3000](http://localhost:3000) (admin / admin123)

---

 Микросервисы и API

 User Service (порт 8001)

| Endpoint        | Описание               |
| --------------- | ---------------------- |
| GET /users/{id} | Получение пользователя |
| GET /health     | Health check           |

 Order Service (порт 8002)

| Endpoint              | Описание            |
| --------------------- | ------------------- |
| GET /orders/user/{id} | Заказы пользователя |
| GET /health           | Health check        |

 Product Service (порт 8003)

| Endpoint             | Описание                 |
| -------------------- | ------------------------ |
| GET /products/{id}   | Получение товара         |
| POST /products/batch | Получение списка товаров |
| GET /health          | Health check             |

---

 API Gateway

 Агрегирующий endpoint

```http
GET /api/profile/{user_id}
```

Endpoint агрегирует:

* данные пользователя
* список заказов
* данные товаров, связанных с заказами

---

 Кэширование

* Redis используется для хранения агрегированных данных
* TTL кэша — 30 секунд
* При недоступности Redis используется in-memory кэш

Собираемые метрики:

* cache_hits_total
* cache_misses_total
* aggregation_duration_seconds

---

 Мониторинг

 Доступ к компонентам

| Компонент           | URL                                                            | Назначение          |
| ------------------- | -------------------------------------------------------------- | ------------------- |
| Prometheus          | [http://localhost:9090](http://localhost:9090)                 | Сбор метрик         |
| Grafana             | [http://localhost:3000](http://localhost:3000)                 | Визуализация метрик |
| API Gateway Metrics | [http://localhost:8000/metrics](http://localhost:8000/metrics) | Метрики API Gateway |
| Redis Exporter      | [http://localhost:9121/metrics](http://localhost:9121/metrics) | Метрики Redis       |
| Node Exporter       | [http://localhost:9100/metrics](http://localhost:9100/metrics) | Системные метрики   |

---

 Собираемые метрики

 HTTP метрики API Gateway

* http_requests_total
* http_request_duration_seconds
* http_active_requests

 Метрики кэширования

* cache_hits_total
* cache_misses_total

 Метрики ошибок

* service_errors_total

 Redis метрики

* Использование памяти
* Количество подключений
* Hit / Miss ratio
* Команды в секунду

 Системные метрики

* CPU
* Память
* Диск
* Сеть

---

 Отказоустойчивость

* Параллельные запросы к микросервисам
* Обработка ошибок отдельных сервисов
* Возврат частичных данных при сбоях
* Graceful degradation

---

 Логирование

* Структурированное логирование
* Формат JSON

---

 Сценарий использования

1. Клиент отправляет запрос на API Gateway
2. API Gateway проверяет наличие данных в Redis
3. При отсутствии кэша выполняются параллельные запросы к микросервисам
4. Полученные данные агрегируются
5. Результат сохраняется в кэш
6. Ответ возвращается клиенту
7. Метрики собираются Prometheus
8. Данные визуализируются в Grafana

---

 Примечание

Проект выполнен в учебных целях для изучения микросервисной архитектуры и инструментов мониторинга.
